import{ethers}from"https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.min.js";const NETWORKS={bsc:{chainId:"0x38",chainName:"Binance Smart Chain",rpcUrls:["https://bsc-dataseed.binance.org/"],nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},blockExplorerUrls:["https://bscscan.com"]},ethereum:{chainId:"0x1",chainName:"Ethereum Mainnet",rpcUrls:["https://mainnet.infura.io/v3/"],nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},blockExplorerUrls:["https://etherscan.io"]},polygon:{chainId:"0x89",chainName:"Polygon Mainnet",rpcUrls:["https://polygon-rpc.com/"],nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},blockExplorerUrls:["https://polygonscan.com"]},base:{chainId:"0x2105",chainName:"Base Mainnet",rpcUrls:["https://mainnet.base.org/"],nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},blockExplorerUrls:["https://basescan.org"]},avalanche:{chainId:"0xA86A",chainName:"Avalanche Mainnet",rpcUrls:["https://api.avax.network/ext/bc/C/rpc"],nativeCurrency:{name:"AVAX",symbol:"AVAX",decimals:18},blockExplorerUrls:["https://snowtrace.io"]}};const CONTRACT_ADDRESS="0xe265ba69de5fbc462bdfad8186709e5d025225b0",ABI=["function setProfile(string calldata json) external payable","function getProfile(address user) public view returns (string memory)","function setProfileFree(address user, string calldata json) external","function updateFeeReceiver(address newFeeReceiver) external","function updateFeeAmount(uint256 newFeeAmount) external","function pause() external","function resume() external","function emergencyWithdraw(address payable to, uint256 amount) external","function transferOwnership(address newOwner) external","function renounceOwnership() external","function getContractBalance() external view returns (uint256)","function hasProfile(address user) external view returns (bool)","function getContractInfo() external view returns (address, address, uint256, bool, uint256)","function calculateRefund(uint256 paidAmount) external view returns (uint256)","event ProfileUpdated(address indexed user, string json)","event FeeCollected(address indexed user, uint256 amount)","event ExcessRefunded(address indexed user, uint256 amount)","event FeeReceiverUpdated(address indexed oldReceiver, address indexed newReceiver)","event FeeAmountUpdated(uint256 oldAmount, uint256 newAmount)"];const FEE_AMOUNT="0.0015",FEE_RECEIVER="0x4A0153E289b475Fd8693f415C00813dC77b50E64",connectButton=document.getElementById("connectBtn"),walletAddressSpan=document.getElementById("walletAddr"),nameInput=document.getElementById("name"),descriptionInput=document.getElementById("description"),photoInput=document.getElementById("photo"),addLinkButton=document.getElementById("addLinkBtn"),linksList=document.getElementById("linksList"),previewName=document.getElementById("previewName"),previewAddr=document.getElementById("previewAddr"),previewDescription=document.getElementById("previewDescription"),avatarImg=document.getElementById("avatarImg"),previewLinks=document.getElementById("previewLinks"),saveButton=document.getElementById("saveBtn"),networkName=document.getElementById("networkName"),previewButton=document.getElementById("previewBtn"),avatarPlaceholder=document.getElementById("avatarPlaceholder"),charCount=document.getElementById("charCount"),walletModal=document.getElementById("walletModal"),closeModal=document.getElementById("closeModal"),networkLogo=document.getElementById("networkLogo"),networkDropdown=document.getElementById("networkDropdown"),mobileNetworkWarning=document.getElementById("mobileNetworkWarning"),profileTypeSelect=document.getElementById("profileType"),tokenContractField=document.getElementById("tokenContractField"),tokenContractInput=document.getElementById("tokenContract"),previewType=document.getElementById("previewType"),rolesSection=document.getElementById("rolesSection"),roleCheckboxes=document.querySelectorAll('.role-checkbox input[type="checkbox"]'),tokenContractPreview=document.getElementById("tokenContractPreview"),previewTokenContract=document.getElementById("previewTokenContract"),badgesPreview=document.getElementById("badgesPreview"),tokenChartPreview=document.getElementById("tokenChartPreview"),AVAILABLE_ICONS=["bi-globe","bi-twitter-x","bi-facebook","bi-instagram","bi-linkedin","bi-github","bi-discord","bi-telegram","bi-youtube","bi-tiktok","bi-reddit","bi-whatsapp","bi-envelope","bi-link-45deg","bi-share","bi-heart","bi-star","bi-bookmark","bi-flag","bi-gear","bi-house","bi-person","bi-people","bi-chat","bi-send","bi-camera","bi-image","bi-music-note","bi-film","bi-mic"];let signer=null,userAddress=null,currentNetwork="bsc";const isMobileDevice=()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);function checkMobileNetworkWarning(){isMobileDevice()&&currentNetwork!=="bsc"&&signer?mobileNetworkWarning.classList.add("show"):mobileNetworkWarning.classList.remove("show")}networkLogo.addEventListener("click",e=>{e.stopPropagation(),networkDropdown.classList.toggle("active")}),document.addEventListener("click",e=>{networkLogo.contains(e.target)||networkDropdown.contains(e.target)||(networkDropdown.classList.remove("active"))}),document.querySelectorAll(".network-option").forEach(option=>{option.addEventListener("click",async()=>{const chain=option.getAttribute("data-chain");document.querySelectorAll(".network-option").forEach(opt=>opt.classList.remove("active")),option.classList.add("active");const logoImage=option.querySelector("img").src;networkLogo.querySelector("img").src=logoImage,networkDropdown.classList.remove("active");try{window.ethereum&&signer?(await switchNetwork(chain),currentNetwork=chain,updateNetworkInfo(),checkMobileNetworkWarning()):(currentNetwork=chain,updateNetworkInfo(),checkMobileNetworkWarning())}catch(error){console.error("Erro ao mudar de rede:",error),alert("Error switching to the selected network. Please check if your wallet supports this network.")}})});async function switchNetwork(chain){if(!window.ethereum)throw new Error("Wallet not detected");const networkConfig=NETWORKS[chain];if(!networkConfig)throw new Error("Network not supported");try{await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:networkConfig.chainId}]})}catch(switchError){if(switchError.code===4902)try{await window.ethereum.request({method:"wallet_addEthereumChain",params:[networkConfig]})}catch(addError){throw new Error("It was not possible to add the network to the wallet")}else throw switchError}}function updateNetworkInfo(){const networkNames={bsc:"BSC",ethereum:"Ethereum",polygon:"Polygon",base:"Base",avalanche:"Avalanche"};networkName.textContent=networkNames[currentNetwork]||"Rede Desconhecida"}connectButton.onclick=()=>{signer||(walletModal.style.display="flex",void walletModal.offsetWidth)},closeModal.onclick=()=>{walletModal.style.display="none"},window.onclick=e=>{e.target===walletModal&&(walletModal.style.display="none")},document.getElementById("metamaskOption").onclick=connectWallet,document.getElementById("binanceOption").onclick=()=>alert("Add chartinbio.com directly to your wallet's browser to continue.");async function connectWallet(){if(window.ethereum)try{await window.ethereum.request({method:"eth_requestAccounts"});const provider=new ethers.BrowserProvider(window.ethereum);signer=await provider.getSigner(),userAddress=await signer.getAddress(),walletAddressSpan.textContent=`${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}`,previewAddr.textContent=`${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}`;const network=await provider.getNetwork();currentNetwork=getNetworkFromChainId(network.chainId),updateNetworkInfo(),connectButton.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.58L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor"/></svg>Desconectar`,walletModal.style.display="none",await loadProfileOnChain(userAddress,provider),checkMobileNetworkWarning()}catch(error){console.error("Erro ao conectar:",error),alert("Erro ao conectar carteira: "+error.message)}else isMobileDevice()?window.location.href=`https://metamask.app.link/dapp/${window.location.host}${window.location.pathname}`:alert("MetaMask not found. Please install MetaMask to continue.")}function getNetworkFromChainId(chainId){const chainIdHex="0x"+chainId.toString(16),chainIdMap={"0x1":"ethereum","0x38":"bsc","0x89":"polygon","0x2105":"base","0xA86A":"avalanche"};return chainIdMap[chainIdHex]||"unknown"}function disconnectWallet(){signer=null,userAddress=null,walletAddressSpan.textContent="not connected",connectButton.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 9H21V11H13V9ZM13 13H21V15H13V13ZM13 17H21V19H13V17ZM4 19H10V21H4C2.9 21 2 20.1 2 19V5C2 3.9 2.9 3 4 3H10V5H4V19ZM7 11H9V9H7V11ZM7 15H9V13H7V15ZM7 19H9V17H7V19Z" fill="currentColor"/></svg>Connect`,mobileNetworkWarning.classList.remove("show");const getLinksData=()=>Array.from(linksList.querySelectorAll(".link-item")).map(e=>({url:e.querySelector(".link-url-input").value,icon:e.querySelector(".icon-selector i").className})).filter(e=>e.url),getSelectedRoles=()=>{const e=[];return roleCheckboxes.forEach(t=>{t.checked&&e.push(t.value)}),e};function renderPreview(){previewName.textContent=nameInput.value||"Name";const e=descriptionInput.value||"Your description will appear here...";previewDescription.textContent=e,photoInput.value?(avatarImg.src=photoInput.value,avatarImg.style.display="block",avatarPlaceholder.style.display="none"):(avatarImg.style.display="none",avatarPlaceholder.style.display="block");const t=profileTypeSelect.value;"project"===t?(previewType.textContent="Projeto",previewType.style.display="block",tokenContractInput.value?(tokenContractPreview.style.display="block",tokenChartPreview.style.display="block",previewTokenContract.textContent=tokenContractInput.value):(tokenContractPreview.style.display="none",tokenChartPreview.style.display="none"),badgesPreview.style.display="none"):(previewType.textContent="Pessoal",previewType.style.display="block",tokenContractPreview.style.display="none",tokenChartPreview.style.display="none");const n=getSelectedRoles();n.length>0?(badgesPreview.style.display="flex",badgesPreview.innerHTML="",n.forEach(e=>{const t=document.createElement("div");t.className=`badge ${e}`;let n="";switch(e){case"ceo":n="ðŸ‘‘";break;case"hold":n="ðŸ’Ž";break;case"coo":n="âš™ï¸";break;case"cto":n="ðŸ’»";break;case"cfo":n="ðŸ’°";break;case"cmo":n="ðŸ“¢";break;case"kol":n="ðŸŽ¥";break;case"dev":n="ðŸ”§"}t.innerHTML=`${n} ${e.toUpperCase()}`,badgesPreview.appendChild(t)})):(badgesPreview.style.display="none"),previewLinks.innerHTML="",getLinksData().forEach(e=>{const t=document.createElement("a");t.href=e.url,t.target="_blank",t.className="preview-link-item",t.innerHTML=`<div class="preview-link-icon"><i class="${e.icon}"></i></div>`,previewLinks.appendChild(t)})}function addLinkItem(e="https://",t="bi-link-45deg"){const n=document.createElement("div");n.className="link-item";const a=document.createElement("div");a.className="icon-selector-container";const l=document.createElement("div");l.className="icon-selector",l.innerHTML=`<i class="${t}"></i>`;const r=document.createElement("div");r.className="icon-dropdown",AVAILABLE_ICONS.forEach(t=>{const i=document.createElement("div");i.className="icon-option",i.innerHTML=`<i class="${t}"></i>`,i.addEventListener("click",()=>{l.innerHTML=`<i class="${t}"></i>`,r.classList.remove("active"),renderPreview()}),r.appendChild(i)}),l.addEventListener("click",e=>{e.stopPropagation(),document.querySelectorAll(".icon-dropdown.active").forEach(e=>{e!==r&&e.classList.remove("active")}),r.classList.toggle("active")}),document.addEventListener("click",e=>{a.contains(e.target)||r.classList.remove("active")}),a.appendChild(l),a.appendChild(r);const i=document.createElement("input");i.className="link-url-input",i.placeholder="https://...",i.value=e;const o=document.createElement("div");o.className="link-item-row",o.append(a,i);const s=document.createElement("button");s.innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/></svg> Remove`,s.onclick=()=>{n.remove(),renderPreview()},n.append(o,s),linksList.appendChild(n),i.oninput=renderPreview,renderPreview()}profileTypeSelect.addEventListener("change",function(){this.value==="project"?(tokenContractField.classList.add("visible"),rolesSection.classList.remove("visible")):(tokenContractField.classList.remove("visible"),rolesSection.classList.add("visible")),renderPreview()}),roleCheckboxes.forEach(e=>{e.addEventListener("change",function(){const t=this.closest(".role-checkbox");this.checked?t.classList.add("checked"):t.classList.remove("checked"),renderPreview()})}),addLinkButton.onclick=()=>addLinkItem(),addLinkItem("https://","bi-globe"),[nameInput,descriptionInput,photoInput,tokenContractInput].forEach(e=>e.oninput=renderPreview),descriptionInput.addEventListener("input",()=>{const e=descriptionInput.value.length;charCount.textContent=e,e>450?charCount.style.color="var(--warning)":charCount.style.color="var(--text-muted)",e>=500&&(charCount.style.color="var(--danger)")});async function getGasPriceWithMargin(e,t=10){try{const n=await e.getFeeData(),a=n.gasPrice;if(!a)throw new Error("NÃ£o foi possÃ­vel obter o gas price");const l=BigInt(t);return a*(100n+l)/100n}catch(e){throw console.error("Erro ao obter gas price:",e),e}}async function saveProfileWithFee(){if(!signer){walletModal.style.display="flex",void walletModal.offsetWidth;return}if(!nameInput.value.trim())return void alert("Please fill in at least the profile name.");const e={name:nameInput.value,description:descriptionInput.value,photo:photoInput.value,links:getLinksData(),profileType:profileTypeSelect.value,tokenContract:profileTypeSelect.value==="project"?tokenContractInput.value:"",roles:profileTypeSelect.value==="personal"?getSelectedRoles():[],timestamp:new Date().toISOString()};try{if(!confirm("ðŸ”—All your links in one place on the blockchain.âœ… A single confirmation on MetaMask"))throw new Error("Transaction canceled by the user");const t=new ethers.Contract(CONTRACT_ADDRESS,ABI,signer),n=await getGasPriceWithMargin(signer.provider,15),a=await t.setProfile(JSON.stringify(e),{value:ethers.parseEther(FEE_AMOUNT),gasPrice:n});alert("Confirm transaction...");const l=await a.wait();console.log("âœ… TransaÃ§Ã£o confirmada:",l.blockNumber),alert("ðŸŽ‰ Perfil salvo com sucesso! Taxa processada em uma Ãºnica transaÃ§Ã£o.")}catch(e){console.error("Error saving profile:",e),e.message.includes("Insufficient balance")?alert(`Erro: ${e.message}\n\nPlease add BNB to your wallet and try again.`):e.message.includes("user rejected")?alert("Transaction canceled by the user."):e.message.includes("insufficient fee")?alert("Por favor, use o valor exato de "+FEE_AMOUNT):alert("Error saving profile:"+e.message)}}async function loadProfileOnChain(e,t){const n=new ethers.Contract(CONTRACT_ADDRESS,ABI,t);try{const t=await n.getProfile(e);if(t){const n=JSON.parse(t);nameInput.value=n.name||"",descriptionInput.value=n.description||"",photoInput.value=n.photo||"",linksList.innerHTML="",(n.links||[]).forEach(e=>addLinkItem(e.url,e.icon||"bi-link-45deg")),n.profileType&&(profileTypeSelect.value=n.profileType,profileTypeSelect.dispatchEvent(new Event("change")),n.profileType==="project"&&n.tokenContract&&(tokenContractInput.value=n.tokenContract),n.profileType==="personal"&&n.roles&&roleCheckboxes.forEach(e=>{e.checked=n.roles.includes(e.value);const t=e.closest(".role-checkbox");e.checked?t.classList.add("checked"):t.classList.remove("checked")})),renderPreview(),charCount.textContent=descriptionInput.value.length}}catch(e){console.log("Erro ao carregar perfil:",e)}}saveButton.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM12 19C10.34 19 9 17.66 9 16C9 14.34 10.34 13 12 13C13.66 13 15 14.34 15 16C15 17.66 13.66 19 12 19ZM15 9H5V5H15V9Z" fill="currentColor"/></svg>Save`;const saveButtonContainer=saveButton.parentElement,feeInfo=document.createElement("div");feeInfo.className="small",feeInfo.style.marginTop="8px",feeInfo.style.color="var(--text-muted)",feeInfo.innerHTML="Saving your link profile on the Blockchain.",saveButtonContainer&&saveButtonContainer.appendChild(feeInfo),saveButton.onclick=saveProfileWithFee,previewButton.onclick=()=>{userAddress||(alert("Connect your wallet before opening the public page."),walletModal.style.display="flex",void walletModal.offsetWidth);const e=`profile.html?addr=${userAddress}`;window.open(e,"_blank")},renderPreview(),updateNetworkInfo(),rolesSection.classList.add("visible");
